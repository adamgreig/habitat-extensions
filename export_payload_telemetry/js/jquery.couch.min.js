(function(c){function n(a){var b=a.split("/");return"_design"==b[0]?(b.shift(),"_design/"+encodeURIComponent(b.join("/"))):encodeURIComponent(a)}function g(a,b,f,d){b=c.extend({successStatus:200},b);d=c.extend({contentType:"application/json",headers:{Accept:"application/json"}},d);f=f||"Unknown error";c.ajax(c.extend(c.extend({type:"GET",dataType:"json",cache:!c.browser.msie,beforeSend:function(e){if(d&&d.headers)for(var a in d.headers)e.setRequestHeader(a,d.headers[a])},complete:function(e){try{var a=
l(e,"json")}catch(k){b.error?b.error(e.status,e,k):alert(f+": "+k);return}b.ajaxStart&&b.ajaxStart(a);e.status==b.successStatus?(b.beforeSuccess&&b.beforeSuccess(e,a),b.success&&b.success(a)):b.error?b.error(e.status,a&&a.error||f,a&&a.reason||"no response"):alert(f+": "+a.reason)}},a),d))}function q(a){a=a||{};if("undefined"!==typeof a.ensure_full_commit){var b=a.ensure_full_commit;delete a.ensure_full_commit;return function(a){a.setRequestHeader("Accept","application/json");a.setRequestHeader("X-Couch-Full-Commit",
b.toString())}}}function i(a){var b=[];if("object"===typeof a&&null!==a)for(var f in a)if(!(0<=c.inArray(f,["error","success","beforeSuccess","ajaxStart"]))){var d=a[f];0<=c.inArray(f,["key","startkey","endkey"])&&(d=j(d));b.push(encodeURIComponent(f)+"="+encodeURIComponent(d))}return b.length?"?"+b.join("&"):""}function j(a){return null!==a?JSON.stringify(a):null}c.couch=c.couch||{};var m=[];c.extend(c.couch,{urlPrefix:"",activeTasks:function(a){g({url:this.urlPrefix+"/_active_tasks"},a,"Active task status could not be retrieved")},
allDbs:function(a){g({url:this.urlPrefix+"/_all_dbs"},a,"An error occurred retrieving the list of all databases")},config:function(a,b,f,c){var e={url:this.urlPrefix+"/_config/"};b&&(e.url+=encodeURIComponent(b)+"/",f&&(e.url+=encodeURIComponent(f)));null===c?e.type="DELETE":void 0!==c&&(e.type="PUT",e.data=j(c),e.contentType="application/json",e.processData=!1);g(e,a,"An error occurred retrieving/updating the server configuration")},session:function(a){a=a||{};c.ajax({type:"GET",url:this.urlPrefix+
"/_session",beforeSend:function(a){a.setRequestHeader("Accept","application/json")},complete:function(b){var c=l(b,"json");200==b.status?a.success&&a.success(c):a.error?a.error(b.status,c.error,c.reason):alert("An error occurred getting session info: "+c.reason)}})},userDb:function(a){c.couch.session({success:function(b){b=c.couch.db(b.info.authentication_db);a(b)}})},signup:function(a,b,f){f=f||{};a=this.prepareUserDoc(a,b);c.couch.userDb(function(b){b.saveDoc(a,f)})},prepareUserDoc:function(a,b){if("undefined"==
typeof hex_sha1)alert("creating a user doc requires sha1.js to be loaded in the page");else return a._id=a._id||"org.couchdb.user:"+a.name,b&&(a.salt=c.couch.newUUID(),a.password_sha=hex_sha1(b+a.salt)),a.type="user",a.roles||(a.roles=[]),a},login:function(a){a=a||{};c.ajax({type:"POST",url:this.urlPrefix+"/_session",dataType:"json",data:{name:a.name,password:a.password},beforeSend:function(a){a.setRequestHeader("Accept","application/json")},complete:function(b){var c=l(b,"json");200==b.status?a.success&&
a.success(c):a.error?a.error(b.status,c.error,c.reason):alert("An error occurred logging in: "+c.reason)}})},logout:function(a){a=a||{};c.ajax({type:"DELETE",url:this.urlPrefix+"/_session",dataType:"json",username:"_",password:"_",beforeSend:function(a){a.setRequestHeader("Accept","application/json")},complete:function(b){var c=l(b,"json");200==b.status?a.success&&a.success(c):a.error?a.error(b.status,c.error,c.reason):alert("An error occurred logging out: "+c.reason)}})},db:function(a,b){function f(e){if(e._id&&
e._rev&&d[e._id]&&d[e._id].rev==e._rev){if("undefined"==typeof Base64)return alert("please include /_utils/script/base64.js in the page for base64 support"),!1;e._attachments=e._attachments||{};e._attachments["rev-"+e._rev.split("-")[0]]={content_type:"application/json",data:Base64.encode(d[e._id].raw)};return!0}}var b=b||{},d={};return{name:a,uri:this.urlPrefix+"/"+encodeURIComponent(a)+"/",compact:function(e){c.extend(e,{successStatus:202});g({type:"POST",url:this.uri+"_compact",data:"",processData:!1},
e,"The database could not be compacted")},viewCleanup:function(e){c.extend(e,{successStatus:202});g({type:"POST",url:this.uri+"_view_cleanup",data:"",processData:!1},e,"The views could not be cleaned up")},compactView:function(e,a){c.extend(a,{successStatus:202});g({type:"POST",url:this.uri+"_compact/"+e,data:"",processData:!1},a,"The view could not be compacted")},create:function(a){c.extend(a,{successStatus:201});g({type:"PUT",url:this.uri,contentType:"application/json",data:"",processData:!1},
a,"The database could not be created")},drop:function(a){g({type:"DELETE",url:this.uri},a,"The database could not be deleted")},info:function(a){g({url:this.uri},a,"Database information could not be retrieved")},changes:function(a,h){function b(a){c.each(j,function(){this(a)})}function p(){var b=c.extend({heartbeat:1E4},h,{feed:"longpoll",since:a});g({url:f.uri+"_changes"+i(b)},h,"Error connecting to "+f.uri+"/_changes.")}var h=h||{},d=100,f=this,o=!0,j=[];h.success=function(h){d=100;o&&(a=h.last_seq,
b(h),p())};h.error=function(){o&&(setTimeout(p,d),d*=2)};a?p():f.info({success:function(h){a=h.update_seq;p()}});return{onChange:function(a){j.push(a)},stop:function(){o=!1}}},allDocs:function(a){var h="GET",b=null;a.keys&&(h="POST",b=a.keys,delete a.keys,b=j({keys:b}));g({type:h,data:b,url:this.uri+"_all_docs"+i(a)},a,"An error occurred retrieving a list of all documents")},allDesignDocs:function(a){this.allDocs(c.extend({startkey:"_design",endkey:"_design0"},a))},allApps:function(e){var e=e||{},
h=this;e.eachApp?this.allDesignDocs({success:function(b){c.each(b.rows,function(){h.openDoc(this.id,{success:function(b){var h,c,k=b._id.split("/");k.shift();k=k.join("/");(h=b.couchapp&&b.couchapp.index)?c=["",a,b._id,h].join("/"):b._attachments&&b._attachments["index.html"]&&(c=["",a,b._id,"index.html"].join("/"));c&&e.eachApp(k,c,b)}})})}}):alert("Please provide an eachApp function for allApps()")},openDoc:function(a,h,k){h=h||{};b.attachPrevRev||h.attachPrevRev?c.extend(h,{beforeSuccess:function(a,
e){d[e._id]={rev:e._rev,raw:a.responseText}}}):c.extend(h,{beforeSuccess:function(a,e){e["jquery.couch.attachPrevRev"]&&(d[e._id]={rev:e._rev,raw:a.responseText})}});g({url:this.uri+n(a)+i(h)},h,"The document could not be retrieved",k)},saveDoc:function(a,b){var b=b||{},k=this,d=q(b);if(void 0===a._id)var g="POST",m=this.uri;else g="PUT",m=this.uri+n(a._id);var o=f(a);c.ajax({type:g,url:m+i(b),contentType:"application/json",dataType:"json",data:j(a),beforeSend:d,complete:function(c){var d=l(c,"json");
200==c.status||201==c.status||202==c.status?(a._id=d.id,a._rev=d.rev,o?k.openDoc(a._id,{attachPrevRev:!0,success:function(c){a._attachments=c._attachments;b.success&&b.success(d)}}):b.success&&b.success(d)):b.error?b.error(c.status,d.error,d.reason):alert("The document could not be saved: "+d.reason)}})},bulkSave:function(a,b){var d=q(b);c.extend(b,{successStatus:201,beforeSend:d});g({type:"POST",url:this.uri+"_bulk_docs"+i(b),contentType:"application/json",data:j(a)},b,"The documents could not be saved")},
removeDoc:function(a,b){g({type:"DELETE",url:this.uri+n(a._id)+i({rev:a._rev})},b,"The document could not be deleted")},bulkRemove:function(a,b){a.docs=c.each(a.docs,function(a,b){b._deleted=!0});c.extend(b,{successStatus:201});g({type:"POST",url:this.uri+"_bulk_docs"+i(b),data:j(a)},b,"The documents could not be deleted")},copyDoc:function(a,b,d){d=c.extend(d,{complete:function(a){var e=l(a,"json");201==a.status?b.success&&b.success(e):b.error?b.error(a.status,e.error,e.reason):alert("The document could not be copied: "+
e.reason)}});g({type:"COPY",url:this.uri+n(a)},b,"The document could not be copied",d)},query:function(a,b,c,d){c=c||"javascript";"string"!==typeof a&&(a=a.toSource?a.toSource():"("+a.toString()+")");a={language:c,map:a};null!=b&&("string"!==typeof b&&(b=b.toSource?b.toSource():"("+b.toString()+")"),a.reduce=b);g({type:"POST",url:this.uri+"_temp_view"+i(d),contentType:"application/json",data:j(a)},d,"An error occurred querying the database")},list:function(a,b,c){var a=a.split("/"),c=c||{},d="GET",
f=null;c.keys&&(d="POST",f=c.keys,delete c.keys,f=j({keys:f}));g({type:d,data:f,url:this.uri+"_design/"+a[0]+"/_list/"+a[1]+"/"+b+i(c)},c,"An error occured accessing the list")},view:function(a,b){var a=a.split("/"),b=b||{},c="GET",d=null;b.keys&&(c="POST",d=b.keys,delete b.keys,d=j({keys:d}));g({type:c,data:d,url:this.uri+"_design/"+a[0]+"/_view/"+a[1]+i(b)},b,"An error occurred accessing the view")},getDbProperty:function(a,b,c){g({url:this.uri+a+i(b)},b,"The property could not be retrieved",c)},
setDbProperty:function(a,b,c,d){g({type:"PUT",url:this.uri+a+i(c),data:JSON.stringify(b)},c,"The property could not be updated",d)}}},encodeDocId:n,info:function(a){g({url:this.urlPrefix+"/"},a,"Server information could not be retrieved")},replicate:function(a,b,f,d){d=c.extend({source:a,target:b},d);d.continuous&&!d.cancel&&(f.successStatus=202);g({type:"POST",url:this.urlPrefix+"/_replicate",data:JSON.stringify(d),contentType:"application/json"},f,"Replication failed")},newUUID:function(a){void 0===
a&&(a=1);m.length||g({url:this.urlPrefix+"/_uuids",data:{count:a},async:!1},{success:function(a){m=a.uuids}},"Failed to retrieve UUID batch.");return m.shift()}});var l=c.httpData||function(a,b,f){var d=a.getResponseHeader("content-type")||"",e="xml"===b||!b&&0<=d.indexOf("xml"),a=e?a.responseXML:a.responseText;e&&"parsererror"===a.documentElement.nodeName&&c.error("parsererror");f&&f.dataFilter&&(a=f.dataFilter(a,b));"string"===typeof a&&("json"===b||!b&&0<=d.indexOf("json")?a=c.parseJSON(a):("script"===
b||!b&&0<=d.indexOf("javascript"))&&c.globalEval(a));return a}})(jQuery);